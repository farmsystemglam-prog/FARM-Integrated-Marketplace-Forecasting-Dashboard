<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Profile â€“ F.A.R.M</title>
    <link rel="stylesheet" href="SetCustomerProfile.css">
</head>
<body>

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="logo">
            <img src="FARMLogo.png" alt="FARM Logo">
        </div>

        <nav>
            <a class="active" href="#">Profile</a>
            <a href="FarmerDirectory.html">Farmer Directory</a>
        </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="content">

        <section class="profile-card">

            <h1 class="title">Edit Profile</h1>
            <p class="subtitle">Manage your account details</p>
            <hr>

            <div class="profile-layout">

                <!-- LEFT FORM -->
                <div class="form-section">

                    <label>Username</label>
                    <input type="text" id="username" placeholder="Enter username">

                    <label>Full Name</label>
                    <input type="text" id="full_name" placeholder="Enter full name">

                    <label>Email</label>
                    <input type="email" id="email" placeholder="Enter email" readonly>

                    <label>Address</label>
                    <input type="text" id="address" placeholder="Enter address">

                    <div class="gender-row">
                        <label class="gender-label">Gender</label>

                        <div class="gender-options">
                            <label><input type="radio" name="gender" value="male"> Male</label>
                            <label><input type="radio" name="gender" value="female"> Female</label>
                            <label><input type="radio" name="gender" value="other"> Other</label>
                        </div>
                    </div>

                    <label>Date of Birth</label>
                    <div class="dob">
                        <select id="day">
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                                <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
                                <option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option>
                                <option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option>
                                <option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option>
                                <option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option>
                                <option value="25">25</option><option value="26">26</option><option value="27">27</option><option value="28">28</option>
                                <option value="29">29</option><option value="30">30</option><option value="31">31</option>
                            </select>

                            <select id="month">

                                <option value="Jan">Jan</option><option value="Feb">Feb</option><option value="Mar">Mar</option><option value="Apr">Apr</option>
                                <option value="May">May</option><option value="Jun">Jun</option><option value="Jul">Jul</option><option value="Aug">Aug</option>
                                <option value="Sep">Sep</option><option value="Oct">Oct</option><option value="Nov">Nov</option><option value="Dec">Dec</option>
                            </select>

                            <select id="year">
                                <option value="2025">2025</option><option value="2024">2024</option><option value="2023">2023</option><option value="2022">2022</option>
                                <option value="2021">2021</option><option value="2020">2020</option><option value="2019">2019</option><option value="2018">2018</option>
                                <option value="2017">2017</option><option value="2016">2016</option><option value="2015">2015</option><option value="2014">2014</option>
                                <option value="2013">2013</option><option value="2012">2012</option><option value="2011">2011</option><option value="2010">2010</option>
                                <option value="2009">2009</option><option value="2008">2008</option><option value="2007">2007</option><option value="2006">2006</option>
                                <option value="2005">2005</option><option value="2004">2004</option><option value="2003">2003</option><option value="2002">2002</option>
                                <option value="2001">2001</option><option value="2000">2000</option><option value="1999">1999</option><option value="1998">1998</option>
                                <option value="1997">1997</option><option value="1996">1996</option><option value="1995">1995</option><option value="1994">1994</option>
                                <option value="1993">1993</option><option value="1992">1992</option><option value="1991">1991</option><option value="1990">1990</option>
                                <option value="1989">1989</option><option value="1988">1988</option><option value="1987">1987</option><option value="1986">1986</option>
                                <option value="1985">1985</option><option value="1984">1984</option><option value="1983">1983</option><option value="1982">1982</option>
                                <option value="1981">1981</option><option value="1980">1980</option>
                            </select>
                    </div>

                    <button class="save-btn" id="saveBtn">Save</button>
                </div>

                <!-- VERTICAL DIVIDER -->
                <div class="divider-vertical"></div>

                <!-- RIGHT IMAGE SECTION -->
                <div class="image-section">
                    <div class="profile-pic" id="profilePreview"></div>

                    <input type="file" id="imageUpload" accept="image/png, image/jpeg" hidden>

                    <button class="select-img-btn" onclick="document.getElementById('imageUpload').click();">
                        Select Image
                    </button>

                    <p class="file-info">
                        File size maximum 1 mb <br>
                        File extension: .JPEG, .PNG
                    </p>
                </div>

            </div>

        </section>

        <!-- MESSAGE AREA -->
        <div id="message" class="message"></div>
    </main>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://nzpwmhshnfvwrbkhraed.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56cHdtaHNobmZ2d3Jia2hyYWVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MzcyMTMsImV4cCI6MjA3OTExMzIxM30.IPQzkj0iuTEaxsmgY1fFva916rKcwaEfaAiBQhJHb_o';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global variables
        let currentProfile = null;
        let currentImage = null;

        // Check authentication and role
        async function checkAuthAndRole() {
            try {
                // Get current user
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                
                if (userError || !user) {
                    // User not authenticated, redirect to sign in
                    window.location.href = "SignIn.html";
                    return false;
                }
                
                // Get user's profile to check role
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('role')
                    .eq('id', user.id)
                    .single();
                    
                if (profileError || !profile) {
                    console.error("Profile error:", profileError);
                    showError("Unable to retrieve your profile. Please contact support.");
                    return false;
                }
                
                // Check if user has customer role
                if (profile.role !== 'customer') {
                    console.error("Unauthorized role:", profile.role);
                    showError("You are not authorized to access this page.");
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error("Auth check error:", error);
                showError("An error occurred while checking your authorization.");
                return false;
            }
        }

        // Load customer profile
        async function loadCustomerProfile() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                
                // Get customer profile from profiles table
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                    
                if (profileError || !profile) {
                    console.error("Profile error:", profileError);
                    // If profile doesn't exist, create one with user metadata
                    await createCustomerProfileFromUserMetadata(user);
                    return;
                }
                
                currentProfile = profile;
                
                // Get additional profile data from customer_profiles table
                const { data: customerProfile, error: customerProfileError } = await supabase
                    .from('customer_profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                // Populate form with profile data
                document.getElementById('username').value = customerProfile?.username || '';
                document.getElementById('full_name').value = customerProfile?.name || '';
                document.getElementById('email').value = profile.email || '';
                document.getElementById('address').value = profile.address || '';
                
                // Set gender if available from customer_profiles
                if (customerProfile?.gender) {
                    const genderRadio = document.querySelector(`input[name="gender"][value="${customerProfile.gender}"]`);
                    if (genderRadio) {
                        genderRadio.checked = true;
                    }
                }
                
                // Set date of birth if available from customer_profiles
                if (customerProfile?.date_of_birth) {
                    const dob = new Date(customerProfile.date_of_birth);
                    if (!isNaN(dob.getTime())) { // Check if date is valid
                        document.getElementById('day').value = dob.getDate();
                        document.getElementById('month').value = dob.toLocaleString('default', { month: 'short' });
                        document.getElementById('year').value = dob.getFullYear();
                    }
                }
                
                // Load profile image if available from customer_profiles
                if (customerProfile?.profile_image_url) {
                    document.getElementById('profilePreview').style.backgroundImage = `url('${customerProfile.profile_image_url}')`;
                }
                
            } catch (error) {
                console.error("Error loading customer profile:", error);
                showError("Failed to load your profile. Please try again.");
            }
        }

        // Create customer profile from user metadata
        async function createCustomerProfileFromUserMetadata(user) {
            try {
                // Create basic profile in profiles table
                const profileData = {
                    id: user.id,
                    first_name: user.user_metadata?.first_name || '',
                    last_name: user.user_metadata?.last_name || '',
                    address: user.user_metadata?.address || '',
                    email: user.email,
                    role: 'customer'
                };
                
                const { error: profileError } = await supabase
                    .from('profiles')
                    .insert([profileData]);
                
                if (profileError) {
                    throw new Error('Failed to create customer profile: ' + profileError.message);
                }
                
                // Reload the profile after creation
                await loadCustomerProfile();
                
            } catch (error) {
                console.error("Error creating customer profile:", error);
                showError(error.message);
            }
        }

        // Save customer profile
        async function saveCustomerProfile() {
            try {
                const username = document.getElementById("username").value.trim();
                const full_name = document.getElementById("full_name").value.trim();
                const email = document.getElementById("email").value.trim();
                const address = document.getElementById("address").value.trim();
                const gender = document.querySelector('input[name="gender"]:checked')?.value || '';
                const day = document.getElementById("day").value;
                const month = document.getElementById("month").value;
                const year = document.getElementById("year").value;
                
                // Validation
                if (!username || !full_name || !email || !address) {
                    showError("Please fill in all required fields.");
                    return;
                }
                
                // Parse date of birth more carefully
                let dateOfBirth = null;
                if (day && month && year) {
                    // Create date using UTC to avoid timezone issues
                    const monthIndex = new Date(`${month} 1, 2025`).getMonth();
                    dateOfBirth = new Date(Date.UTC(year, monthIndex, day));
                    
                    // Check if date is valid
                    if (isNaN(dateOfBirth.getTime())) {
                        showError("Invalid date of birth selected.");
                        return;
                    }
                }
                
                // Get current user
                const { data: { user } } = await supabase.auth.getUser();
                
                // Update profiles table
                const { error: updateProfileError } = await supabase
                    .from('profiles')
                    .update({
                        address: address,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', user.id);
                
                if (updateProfileError) {
                    throw new Error(`Failed to update profile: ${updateProfileError.message}`);
                }
                
                // Prepare customer profile data
                const customerProfileData = {
                    username: username,
                    name: full_name,
                    email: email,
                    address: address,
                    gender: gender,
                    date_of_birth: dateOfBirth ? dateOfBirth.toISOString().split('T')[0] : null,
                    profile_image_url: currentImage || null,
                    updated_at: new Date().toISOString()
                };
                
                // Upsert customer_profiles table
                const { error: upsertError } = await supabase
                    .from('customer_profiles')
                    .upsert({
                        id: user.id,
                        ...customerProfileData
                    }, {
                        onConflict: 'id'
                    });
                
                if (upsertError) {
                    throw new Error(`Failed to save customer profile: ${upsertError.message}`);
                }
                
                // Success message
                showSuccess("Profile saved successfully!");
                
                // Redirect to FarmerDirectory after delay
                setTimeout(() => {
                    window.location.href = "FarmerDirectory.html";
                }, 2000);
                
            } catch (error) {
                console.error("Error saving customer profile:", error);
                showError(error.message);
            }
        }

        // Show error message
        function showError(message) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = 'Error: ' + message;
            messageDiv.style.display = 'block';
            messageDiv.style.color = 'red';
        }

        // Show success message
        function showSuccess(message) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            messageDiv.style.color = 'green';
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', async () => {
            // First check authentication and role
            const isAuthorized = await checkAuthAndRole();
            if (!isAuthorized) {
                return; // Stop execution if not authorized
            }
            
            // Load customer profile
            await loadCustomerProfile();
            
            // Profile image upload
            const imageUpload = document.getElementById("imageUpload");
            const profilePreview = document.getElementById("profilePreview");
            
            imageUpload.addEventListener("change", function () {
                const file = this.files[0];
                if (!file) return;
                
                // File size check (MAX 1MB)
                if (file.size > 1 * 1024 * 1024) { 
                    showError("File is too large! Maximum size is 1 MB.");
                    this.value = ""; 
                    return;
                }
                
                // Preview the selected image
                const reader = new FileReader();
                reader.onload = function (e) {
                    profilePreview.style.backgroundImage = `url('${e.target.result}')`;
                    currentImage = e.target.result; // Store the image data
                };
                
                reader.readAsDataURL(file);
            });
            
            // Save button
            document.getElementById("saveBtn").addEventListener("click", saveCustomerProfile);
        });
    </script>

</body>
</html>