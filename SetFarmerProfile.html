<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set up Farmer Profile â€“ F.A.R.M</title>
    <link rel="stylesheet" href="SetFarmerProfile.css">
</head>
<body>

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="logo">
            <img src="FARMLogo.png" alt="FARM Logo">
        </div>
        <nav>
            <a class="active" href="#">Profile Setup</a>
        </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="content">

        <header class="top-header">
            <h2>Farmer Profile Setup</h2>
        </header>

        <!-- WHITE FORM BOX -->
        <section class="container">

            <form class="form-layout" id="farmerProfileForm">

                <h3 class="form-section-title">Business Information</h3>

                <input type="email" id="email" placeholder="Email Address" readonly>
                <input type="text" id="businessName" placeholder="Business Name" required>
                <input type="text" id="ownerName" placeholder="Owner Name" required>
                <input type="text" id="yearEstablished" placeholder="Year Established" required>
                <input type="text" id="location" placeholder="Location / City" required>

                <!-- CROP CATEGORIES -->
                <h3 class="form-section-title">Crop Categories</h3>
                <small class="form-note">Select all that apply:</small>

                <div class="categories-grid">
                    <button type="button" class="toggle-btn" data-value="Vegetables">
                        <span class="toggle-label">Vegetables (Gulay)</span>
                        <span class="toggle-examples">Talong, Sitaw, Ampalaya</span>
                    </button>

                    <button type="button" class="toggle-btn" data-value="Fruits">
                        <span class="toggle-label">Fruits (Prutas)</span>
                        <span class="toggle-examples">Mangga, Papaya, Pinya, Saging</span>
                    </button>

                    <button type="button" class="toggle-btn" data-value="Grains">
                        <span class="toggle-label">Grains (Butil)</span>
                        <span class="toggle-examples">Palay, Mais, Trigo, Oats</span>
                    </button>

                    <button type="button" class="toggle-btn" data-value="Root Crops">
                        <span class="toggle-label">Root Crops (Ugat / Pananim na Ugat)</span>
                        <span class="toggle-examples">Patatas, Kamote, Karot, Labanos</span>
                    </button>

                    <button type="button" class="toggle-btn" data-value="Herbs">
                        <span class="toggle-label">Herbs (Halamang-gamot)</span>
                        <span class="toggle-examples">Tanglad, Wansoy, Oregano, Luyang Dilaw</span>
                    </button>

                    <button type="button" class="toggle-btn" data-value="Spices">
                        <span class="toggle-label">Spices (Mga Pampalasa)</span>
                        <span class="toggle-examples">Paminta, Sili, Luya, Bawang</span>
                    </button>
                </div>

                <h3 class="form-section-title">Description / Bio</h3>
                <textarea id="description" placeholder="Describe your farm and offerings..." required></textarea>

                <div class="button-row">
                    <button type="button" class="btn cancel-btn"
                        onclick="window.location.href='UserType.html'">Cancel</button>
                    <button type="submit" class="btn save-btn">Save Profile</button>
                </div>

            </form>

            <div id="message" class="message"></div>

        </section>
    </main>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://nzpwmhshnfvwrbkhraed.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56cHdtaHNobmZ2d3Jia2hyYWVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MzcyMTMsImV4cCI6MjA3OTExMzIxM30.IPQzkj0iuTEaxsmgY1fFva916rKcwaEfaAiBQhJHb_o';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Check authentication and role
        async function checkAuthAndRole() {
            try {
                // Get current user
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                
                if (userError || !user) {
                    // User not authenticated, redirect to sign in
                    window.location.href = "SignIn.html";
                    return false;
                }
                
                // Try to get user's profile from the profiles table
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('role')
                    .eq('id', user.id)
                    .single();
                
                // If profile doesn't exist, create one with role from user metadata
                if (profileError && profileError.code === 'PGRST116') { // PGRST116 = no rows returned
                    console.log("Profile not found, creating one...");
                    
                    // Get role from user metadata
                    const role = user.user_metadata?.role || 'farmer';
                    
                    // Create profile
                    const { error: insertError } = await supabase
                        .from('profiles')
                        .insert({
                            id: user.id,
                            first_name: user.user_metadata?.first_name || '',
                            last_name: user.user_metadata?.last_name || '',
                            address: user.user_metadata?.address || '',
                            role: role
                        });
                    
                    if (insertError) {
                        console.error("Error creating profile:", insertError);
                        showError("Unable to create your profile. Please contact support.");
                        return false;
                    }
                    
                    // Return true with the role we just set
                    return true;
                }
                
                // If there's an error other than "no rows returned"
                if (profileError) {
                    console.error("Profile error:", profileError);
                    showError("Unable to retrieve your profile. Please contact support.");
                    return false;
                }
                
                // Check if user has farmer role
                if (profile.role !== 'farmer') {
                    console.error("Unauthorized role:", profile.role);
                    showError("You are not authorized to access this page. Your role is: " + profile.role);
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error("Auth check error:", error);
                showError("An error occurred while checking your authorization.");
                return false;
            }
        }

        // Show error message
        function showError(message) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = 'Error: ' + message;
            messageDiv.style.display = 'block';
            messageDiv.style.color = 'red';
        }

        // Show success message
        function showSuccess(message) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            messageDiv.style.color = 'green';
        }

        // On page load, check if farmer profile exists and load it
        document.addEventListener('DOMContentLoaded', async () => {
            // First check authentication and role
            const isAuthorized = await checkAuthAndRole();
            if (!isAuthorized) {
                return; // Stop execution if not authorized
            }
            
            try {
                // Get current user
                const { data: { user } } = await supabase.auth.getUser();
                
                // Display user's email
                document.getElementById('email').value = user.email;
                
                // Load farmer profile
                const { data: profile, error: profileError } = await supabase
                    .from('farmer_profiles')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();
                
                if (profileError && profileError.code !== 'PGRST116') { // PGRST116 = no rows returned
                    throw new Error('Error loading profile: ' + profileError.message);
                }
                
                // If profile doesn't exist, create one with user metadata
                if (!profile) {
                    await createFarmerProfileFromUserMetadata(user);
                    // Reload the profile after creation
                    const { data: newProfile } = await supabase
                        .from('farmer_profiles')
                        .select('*')
                        .eq('user_id', user.id)
                        .single();
                    loadProfileData(newProfile);
                } else {
                    loadProfileData(profile);
                }
            } catch (error) {
                console.error('Error initializing page:', error);
                showError(error.message);
            }
        });

        // Create farmer profile from user metadata
        async function createFarmerProfileFromUserMetadata(user) {
            const profileData = {
                user_id: user.id,
                email: user.email,
                business_name: user.user_metadata.first_name + ' Farm',
                owner_name: user.user_metadata.first_name + ' ' + user.user_metadata.last_name,
                year_established: new Date().getFullYear().toString(),
                location: user.user_metadata.address || '',
                crop_categories: [],
                description: 'Please update your farm description.'
            };
            
            const { error } = await supabase
                .from('farmer_profiles')
                .insert([profileData]);
            
            if (error) {
                throw new Error('Failed to create farmer profile: ' + error.message);
            }
        }

        // Load profile data into the form
        function loadProfileData(profile) {
            document.getElementById('email').value = profile.email;
            document.getElementById('businessName').value = profile.business_name || '';
            document.getElementById('ownerName').value = profile.owner_name || '';
            document.getElementById('yearEstablished').value = profile.year_established || '';
            document.getElementById('location').value = profile.location || '';
            document.getElementById('description').value = profile.description || '';
            
            // Load crop categories and set toggle buttons
            if (profile.crop_categories && profile.crop_categories.length > 0) {
                profile.crop_categories.forEach(category => {
                    const toggleBtn = document.querySelector(`.toggle-btn[data-value="${category}"]`);
                    if (toggleBtn) {
                        toggleBtn.classList.add('active');
                    }
                });
            }
        }

        // Toggle button functionality
        document.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                this.classList.toggle('active');
            });
        });

        // HANDLE FORM SUBMISSION
        document.getElementById('farmerProfileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageDiv = document.getElementById('message');
            messageDiv.style.display = 'block';
            messageDiv.textContent = 'Saving profile...';
            
            try {
                // Get current user
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (userError || !user) {
                    throw new Error('User not authenticated');
                }
                
                // Collect main form values
                const email = document.getElementById("email").value.trim();
                const businessName = document.getElementById("businessName").value.trim();
                const ownerName = document.getElementById("ownerName").value.trim();
                const yearEstablished = document.getElementById("yearEstablished").value.trim();
                const location = document.getElementById("location").value.trim();
                const description = document.getElementById("description").value.trim();
                
                // Get selected crop categories from toggle buttons
                const cropCategories = Array.from(
                    document.querySelectorAll('.toggle-btn.active')
                ).map(btn => btn.dataset.value);
                
                // Validate required fields
                if (
                    !email || !businessName || !ownerName || !yearEstablished || 
                    !location || cropCategories.length === 0 || 
                    !description
                ) {
                    throw new Error('Please fill all required fields and select at least one crop category.');
                }
                
                // Prepare profile data
                const profileData = {
                    user_id: user.id,
                    email: email,
                    business_name: businessName,
                    owner_name: ownerName,
                    year_established: yearEstablished,
                    location: location,
                    crop_categories: cropCategories,
                    description: description,
                    updated_at: new Date().toISOString()
                };
                
                // Update farmer_profiles table
                const { error: updateError } = await supabase
                    .from('farmer_profiles')
                    .update(profileData)
                    .eq('user_id', user.id);
                
                if (updateError) {
                    throw new Error(`Failed to save profile: ${updateError.message}`);
                }
                
                // Success message
                showSuccess('Profile saved successfully!');
                
                // Redirect after delay
                setTimeout(() => {
                    window.location.href = "FarmerViewProfile.html";
                }, 2000);
                
            } catch (error) {
                console.error('Error saving profile:', error);
                showError(error.message);
            }
        });
    </script>
</body>
</html>
